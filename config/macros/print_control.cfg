# ==================== PRINT CONTROL MACROS ====================
# ==================== macros/print_control.cfg ====================
# Main print control operations: start, end, pause, resume, cancel

[gcode_macro _APPLY_BEACON_MATERIAL_OFFSET]
description: Apply material-specific Z offset to Beacon model
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set offsets = printer['gcode_macro _global_var'].beacon_material_offsets %}
    {% set offset = offsets[material]|default(0.0)|float %}
    
    {% if offset != 0.0 %}
        _LOG_STATUS MSG="Applying {material} offset: {offset}mm to Beacon model" LED=busy
        SET_GCODE_OFFSET Z={offset}
        Z_OFFSET_APPLY_PROBE
        SET_GCODE_OFFSET Z=0
        _LOG_STATUS MSG="Beacon model updated with {material} offset" LED=ready
    {% else %}
        _LOG_STATUS MSG="No offset required for {material}" LED=ready
    {% endif %}

[gcode_macro START_PRINT]
description: Optimized start print sequence with material-based chamber control and Beacon proximity meshing
variable_state: 'Prepare'
variable_record_extruder_temp: 0
variable_max_record_extruder_temp: 0
gcode:
    status_busy

    {% set bedtemp = params.BED_TEMP|default(60)|int %}
    {% set hotendtemp = params.EXTRUDER_TEMP|default(230)|int %}
    {% set heatsoak = params.HEATSOAK|default(true)|int %}
    {% set material = params.MATERIAL|default("PLA")|string|upper %}

    # Get chamber target from material lookup table
    {% set filament_temps = printer['gcode_macro _global_var'].filament_chamber_temps %}
    {% set chamber_target = filament_temps[material]|default(0) %}
    _LOG_STATUS MSG="Material={material}, Chamber target={chamber_target}°C"

    {% set prime_amount = printer['gcode_macro _global_var'].prime_amount|float %}

    # Clear any previous M141 settings to avoid conflicts
    SET_GCODE_VARIABLE MACRO=_CHAMBER_CONTROL VARIABLE=target_temp VALUE=0

    M400
    CLEAR_PAUSE
    BED_MESH_CLEAR
    G90

    {% if state == 'Prepare' %}
        _LOG_STATUS MSG="Preparing printer for {material} print (chamber: {chamber_target}°C)" LED=busy

        # For materials requiring chamber heating, do chamber conditioning FIRST
        {% if chamber_target > 0 and heatsoak == true %}
            # Set bed to proper temperature for chamber heating (100°C minimum for enclosed materials)
            {% set chamber_bed_temp = [bedtemp, 100]|max %}
            _LOG_STATUS MSG="Starting bed heating for chamber conditioning"
            status_heating PULSE=1
            M140 S{chamber_bed_temp}

            {% if printer.heater_bed.temperature < chamber_bed_temp %}
                _LOG_STATUS MSG="Waiting for bed to reach {chamber_bed_temp}°C for chamber heating"
                status_heating PULSE=1
                M190 S{chamber_bed_temp}
            {% endif %}

            # Do chamber conditioning with heat soak
            _HEAT_SOAK_CHAMBER BED_TEMP={chamber_bed_temp} MATERIAL={material} CHAMBER={chamber_target}

        {% else %}
            # No chamber heating required - start bed heating
            _LOG_STATUS MSG="Starting bed heating (no chamber required)"
            status_heating PULSE=1
            M140 S{bedtemp}

            {% if printer.heater_bed.temperature < bedtemp %}
                _LOG_STATUS MSG="Waiting for bed to reach {bedtemp}°C"
                status_heating PULSE=1
                M190 S{bedtemp}
            {% endif %}

            {% if heatsoak == true %}
                _HEAT_SOAK_CHAMBER BED_TEMP={bedtemp} MATERIAL={material} CHAMBER={chamber_target}
            {% endif %}
        {% endif %}

        # Heat nozzle to 150°C for accurate probing and cleaning
        _LOG_STATUS MSG="Heating nozzle to 150°C for probe operations"
        status_heating PULSE=1
        M109 S150

        # Home XY axes first
        _LOG_STATUS MSG="Homing X and Y axes" LED=homing
        G28 X Y

        # Initial contact calibration - establishes baseline model for scan mode
        _LOG_STATUS MSG="Initial contact calibration" LED=homing
        G28 Z METHOD=CONTACT CALIBRATE=1

        # QGL with proximity probing - ALWAYS run to ensure level gantry
        # Gantry can drift between prints due to thermal expansion and mechanical settling
        _LOG_STATUS MSG="Performing quad gantry leveling" LED=leveling
        QUAD_GANTRY_LEVEL PROBE_METHOD=proximity

        # Use proximity (scan mode) for fast, accurate bed meshing
        _LOG_STATUS MSG="Beacon proximity bed meshing (scan mode)" LED=meshing
        BED_MESH_CALIBRATE ADAPTIVE=1 PROBE_METHOD=proximity

        # Force mesh save/load for consistency
        BED_MESH_PROFILE SAVE=adaptivemesh
        BED_MESH_PROFILE LOAD=adaptivemesh

        # Clean nozzle before final calibration
        _LOG_STATUS MSG="Starting nozzle cleaning" LED=cleaning
        #CLEAN_NOZZLE

        # Final contact calibration after all mechanical operations (QGL, mesh)
        # This ensures Z offset accounts for any gantry/bed changes from leveling
        _LOG_STATUS MSG="Final Z contact calibration" LED=busy
        G28 Z METHOD=CONTACT CALIBRATE=0

        # Apply material-specific offset after final calibration
        _APPLY_BEACON_MATERIAL_OFFSET MATERIAL={material}

        M400

        # Check if SMART_PARK would be within bounds
        {% set min_x = 43 %}
        {% set min_y = 43 %}
        {% set max_x = 333 %}
        {% set max_y = 337 %}
        
        # Default to safe operation
        {% set can_park = true %}
        {% set can_purge = true %}
        
        {% if printer.exclude_object is defined %}
            {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
            {% if all_points|length > 0 %}
                {% set print_min_x = all_points | map(attribute=0) | min %}
                {% set print_min_y = all_points | map(attribute=1) | min %}
                {% set print_max_x = all_points | map(attribute=0) | max %}
                {% set print_max_y = all_points | map(attribute=1) | max %}
                
                # Check if park location would be in bounds
                {% set park_x = print_min_x %}
                {% set park_y = print_max_y %}
                {% if park_x < min_x or park_x > max_x or park_y < min_y or park_y > max_y %}
                    {% set can_park = false %}
                {% endif %}
                
                # Check if purge location would be in bounds (purge is typically in front/left of print)
                {% set purge_margin = printer['gcode_macro _KAMP_Settings'].purge_margin|default(20)|float %}
                {% set purge_x = print_min_x %}
                {% set purge_y = print_min_y - purge_margin %}
                {% if purge_x < min_x or purge_y < min_y %}
                    {% set can_purge = false %}
                {% endif %}
            {% endif %}
        {% endif %}
        
        {% if can_park %}
            _LOG_STATUS MSG="Smart parking" LED=busy
            SMART_PARK
            M400
            _SAVE_SMART_PARK_POSITION
        {% else %}
            _LOG_STATUS MSG="Smart park out of bounds, using safe center position" LED=busy
            G0 X188 Y184 Z10 F12000
        {% endif %}

        # Heat nozzle to print temperature after all probing
        _LOG_STATUS MSG="Heating nozzle to {hotendtemp}°C for printing"
        status_heating PULSE=1
        M109 S{hotendtemp}

        # Thermal expansion compensation - tune this value for your hotend
        # Probing at 150°C requires offset when heating to print temp
        # High-flow hotends may need larger offsets (0.08-0.12mm)
        #SET_GCODE_OFFSET Z=0.06

        _LOG_STATUS MSG="Performing line purge" LED=busy
        {% if can_purge %}
            LINE_PURGE
        {% else %}
            _LOG_STATUS MSG="KAMP purge out of bounds, using safe front edge purge" LED=busy
            # Purge at absolute front edge of bed (Y=3), away from any possible print
            # Prints can't be here since bed mesh starts at Y=43
            SAVE_GCODE_STATE NAME=safe_purge
            G90
            M83
            # Start at bed center X, front edge Y
            G0 X{(min_x + max_x) / 2} Y10 Z0.85 F12000
            G92 E0
            G1 E{printer['gcode_macro _KAMP_Settings'].tip_distance|default(4)|float} F{printer['gcode_macro _KAMP_Settings'].flow_rate|default(12)|float * 60}
            # Purge 100mm line across the front
            G1 X{(min_x + max_x) / 2 + 50} E{printer['gcode_macro _KAMP_Settings'].purge_amount|default(30)|float} F500
            G1 E-0.5 F1800
            G0 Z1.5 F3000
            G92 E0
            RESTORE_GCODE_STATE NAME=safe_purge
        {% endif %}

        # Set LED to printing status (white)
        status_printing
        _LOG_STATUS MSG="Print started successfully"
    {% endif %}

[gcode_macro END_PRINT]
description: Print completion sequence with LED status
variable_state: 'normal'
gcode:
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set e_mintemp = printer.configfile.settings['extruder'].min_extrude_temp %}

    status_busy
    M400
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0

    _LOG_STATUS MSG="Print completed - finalizing" LED=busy
    G91
    {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
          printer.extruder.temperature >= e_mintemp
    %}
        G1 E-2 F2700
        G1 E-2 Z0.2 F2400
    {% endif %}

    {% if (printer.gcode_move.position.z + 25) < z_max %}
        G1 Z+25 F3000
    {% else %}
        G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    G90
    G1 X13 Y350 F9000

    _ALL_FAN_OFF
    TURN_OFF_HEATERS

    M84 X Y Z E
    M220 S100
    M221 S100

    CLEAR_PAUSE
    BED_MESH_CLEAR

    # Set to bright green (completed) and hold it for 5 seconds, then go to white
    status_completed
    _LOG_STATUS MSG="Print completed successfully - printer ready"
    G4 P5000
    status_white

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
variable_state: 'normal'
gcode:
    {% if printer.pause_resume.is_paused == False %}
        {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
        {% set filament_change_retract = printer['gcode_macro _global_var'].filament_change_retract|float %}
        {% set unload_retract = printer['gcode_macro _global_var'].unload_retract_amount|float %}
        {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
        {% set z_lift = printer['gcode_macro _global_var'].pause_park.z %}
        {% set smart_x = printer['gcode_macro _global_var'].smart_park_x %}
        {% set smart_y = printer['gcode_macro _global_var'].smart_park_y %}
        {% set travel_speed = printer['gcode_macro _global_var'].pause_resume_travel_speed * 60 %}
        
        {% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}
        
        _LOG_STATUS MSG="Pausing print - state: {state}" LED=paused
        
        PAUSE_BASE
        status_paused
        
        G91
        {% if (printer.gcode_move.position.z + z_lift) < z_max %}
            G1 Z{z_lift} F3000
        {% else %}
            G1 Z{(z_max - printer.gcode_move.position.z)} F3000
        {% endif %}
        G90
        
        G1 X{smart_x} Y{smart_y} F{travel_speed}
        
        M104 S{printer.extruder.target}
        
        {% if state == 'normal' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                G91
                G1 E-{e_restract} F300
                G90
            {% endif %}
        {% elif state == 'filament_change' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                G91
                G1 E+{filament_change_retract} F300
                G1 E-10 F1500
                G1 E-20 F600
                M400
                G4 P3000
                G1 E-{unload_retract} F300
                G90
            {% endif %}
        {% endif %}
        
        _LOG_STATUS MSG="Print paused successfully" LED=paused
    {% else %}
        _LOG_WARNING MSG="Print already paused"
    {% endif %}

[gcode_macro RESUME]
description: Resume the actual running print with LED status
rename_existing: RESUME_BASE
variable_state: 'normal'
gcode:
    {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
    {% set load_prime = printer['gcode_macro _global_var'].load_prime_amount|float %}
    {% set extruder_target_temp = printer.extruder.target|int %}

    {% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}

    {% if state == 'filament_change' %}
        {% if printer.extruder.temperature + 5 >= printer.extruder.target %}
            status_busy
            G91
            G1 E{load_prime} F300
            G1 E10 F150
            G90
        {% else %}
            M104 S{extruder_target_temp}
            _LOG_STATUS MSG="Heating nozzle to {extruder_target_temp}°C for filament change"
            status_heating PULSE=1
            M109 S{extruder_target_temp}
            G91
            G1 E{load_prime} F300
            G1 E10 F150
            G90
        {% endif %}
        status_printing
        _LOG_STATUS MSG="Resuming print after filament change"
        RESUME_BASE
    {% elif state == 'normal' %}
        G91
        G1 E{e_restract} F300
        G90
        status_printing
        _LOG_STATUS MSG="Resuming print from pause"
        RESUME_BASE
        #SET_FAN_SPEED FAN=hotend_cooling_fan SPEED={printer['gcode_macro _global_var'].hotend_cooling_fan_speed}
    {% endif %}

[gcode_macro CANCEL_PRINT]
description: Cancel print with LED status
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% set e_restract = printer['gcode_macro _global_var'].cancel_park.e|float %}
    {% set e_mintemp = printer.configfile.settings['extruder'].min_extrude_temp %}

    CANCEL_PRINT_BASE
    status_busy

    _LOG_STATUS MSG="Print cancellation initiated" LED=busy
    G91
    {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
          printer.extruder.temperature >= e_mintemp
    %}
        G1 E-{e_restract} F500
    {% else %}
        _LOG_WARNING MSG="Nozzle not hot enough for retraction"
    {% endif %}

    PARK_FOR_CANCEL

    TURN_OFF_HEATERS
    _ALL_FAN_OFF

    CLEAR_PAUSE
    M84 X Y Z E

    _LOG_STATUS MSG="Print cancelled successfully - printer ready" LED=ready
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0

[gcode_macro M600]
gcode:
    PAUSE STATE=filament_change

# ==================== BEACON UTILITY MACROS ====================

[gcode_macro BEACON_ACCURACY_TEST]
description: Run probe accuracy test with current Beacon setup
gcode:
    {% set samples = params.SAMPLES|default(10)|int %}
    _LOG_STATUS MSG="Running Beacon accuracy test ({samples} samples)" LED=busy
    PROBE_ACCURACY SAMPLES={samples} PROBE_METHOD=proximity
    _LOG_STATUS MSG="Beacon accuracy test completed" LED=ready

[gcode_macro BEACON_CONTACT_ACCURACY_TEST]
description: Run contact probe accuracy test
gcode:
    {% set samples = params.SAMPLES|default(10)|int %}
    _LOG_STATUS MSG="Running Beacon contact accuracy test ({samples} samples)" LED=busy
    PROBE_ACCURACY SAMPLES={samples} PROBE_METHOD=contact
    _LOG_STATUS MSG="Beacon contact accuracy test completed" LED=ready