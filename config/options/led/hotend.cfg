[neopixel hotend_rgb]
pin: toolhead:gpio7
chain_count: 3
color_order: GRB
initial_RED: 0.01
initial_GREEN: 0.01
initial_BLUE: 0.01
initial_WHITE: 0.1

[gcode_macro _led_vars]
variable_colors: {
        'ready': {'r': 0.0, 'g': 0.3, 'b': 0.1},
        'busy': {'r': 0.2, 'g': 0.0, 'b': 0.0},
        'heating': {'r': 0.5, 'g': 0.1, 'b': 0.0},
        'heating_dim': {'r': 0.25, 'g': 0.05, 'b': 0.0},
        'printing': {'r': 0.5, 'g': 0.5, 'b': 0.5},
        'homing': {'r': 0.0, 'g': 0.5, 'b': 0.1},
        'leveling': {'r': 0.25, 'g': 0.05, 'b': 0.2},
        'meshing': {'r': 0.1, 'g': 0.5, 'b': 0.0},
        'cleaning': {'r': 0.0, 'g': 0.01, 'b': 0.25},
        'error': {'r': 0.5, 'g': 0.0, 'b': 0.0},
        'paused': {'r': 0.5, 'g': 0.5, 'b': 0.0},
        'completed': {'r': 0.0, 'g': 0.5, 'b': 0.0},
        'off': {'r': 0.0, 'g': 0.0, 'b': 0.0},
        'white': {'r': 0.5, 'g': 0.5, 'b': 0.5},
        'standby': {'r': 0.025, 'g': 0.025, 'b': 0.025},
        'idle': {'r': 0.3, 'g': 0.1, 'b': 0.4},
        'h0': {'r': 0.5, 'g': 0.4, 'b': 0.0},
        'h1': {'r': 0.5, 'g': 0.35, 'b': 0.0},
        'h2': {'r': 0.5, 'g': 0.3, 'b': 0.0},
        'h3': {'r': 0.5, 'g': 0.25, 'b': 0.0},
        'h4': {'r': 0.5, 'g': 0.2, 'b': 0.0},
        'h5': {'r': 0.5, 'g': 0.15, 'b': 0.0},
        'h6': {'r': 0.5, 'g': 0.1, 'b': 0.0},
        'h7': {'r': 0.5, 'g': 0.05, 'b': 0.0},
        'h8': {'r': 0.5, 'g': 0.0, 'b': 0.0},
        'h9': {'r': 0.5, 'g': 0.05, 'b': 0.0},
        'h10': {'r': 0.5, 'g': 0.1, 'b': 0.0},
        'h11': {'r': 0.5, 'g': 0.15, 'b': 0.0},
        'h12': {'r': 0.5, 'g': 0.2, 'b': 0.0},
        'h13': {'r': 0.5, 'g': 0.25, 'b': 0.0},
        'h14': {'r': 0.5, 'g': 0.3, 'b': 0.0},
        'h15': {'r': 0.5, 'g': 0.35, 'b': 0.0},
    }
variable_led_name: "hotend_rgb"
variable_pulse_active: False
variable_pulse_stage: 0
gcode:

[gcode_macro _set_hotend_led]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set led_name = printer["gcode_macro _led_vars"].led_name %}
    
    # Set center LED (Index 1) to status color
    SET_LED LED={led_name} RED={red} GREEN={green} BLUE={blue} INDEX=1
    
    # Set left and right LEDs (Index 2 and 3) to bright white
    SET_LED LED={led_name} RED=1.0 GREEN=1.0 BLUE=1.0 INDEX=2
    SET_LED LED={led_name} RED=1.0 GREEN=1.0 BLUE=1.0 INDEX=3

[gcode_macro _set_hotend_led_by_name]
gcode:
    {% set color_name = params.COLOR %}
    {% set colors = printer["gcode_macro _led_vars"].colors %}
    {% set color = colors[color_name] %}
    
    _set_hotend_led RED={color.r} GREEN={color.g} BLUE={color.b}

[gcode_macro _start_pulse]
gcode:
    {% set base_color = params.COLOR|default("heating") %}
    SET_GCODE_VARIABLE MACRO=_led_vars VARIABLE=pulse_active VALUE=True
    SET_GCODE_VARIABLE MACRO=_led_vars VARIABLE=pulse_stage VALUE=0
    _set_hotend_led_by_name COLOR={base_color}
    UPDATE_DELAYED_GCODE ID=led_pulse_timer DURATION=0.25

[gcode_macro _stop_pulse]
gcode:
    SET_GCODE_VARIABLE MACRO=_led_vars VARIABLE=pulse_active VALUE=False
    SET_GCODE_VARIABLE MACRO=_led_vars VARIABLE=pulse_stage VALUE=0
    UPDATE_DELAYED_GCODE ID=led_pulse_timer DURATION=0

[delayed_gcode led_pulse_timer]
gcode:
    {% if printer["gcode_macro _led_vars"].pulse_active %}
        {% set led_name = printer["gcode_macro _led_vars"].led_name %}
        {% set stage = printer["gcode_macro _led_vars"].pulse_stage %}
        {% set colors = printer["gcode_macro _led_vars"].colors %}
        
        # Keep left and right LEDs white (Index 2 and 3)
        SET_LED LED={led_name} RED=1.0 GREEN=1.0 BLUE=1.0 INDEX=2
        SET_LED LED={led_name} RED=1.0 GREEN=1.0 BLUE=1.0 INDEX=3
        
        # Get current color from heating gradient (h0 through h15)
        {% set color_key = "h" ~ stage %}
        {% set color = colors[color_key] %}
        SET_LED LED={led_name} RED={color.r} GREEN={color.g} BLUE={color.b} INDEX=1
        
        # Advance to next stage (cycle back to 0 after 15)
        {% set next_stage = (stage + 1) % 16 %}
        SET_GCODE_VARIABLE MACRO=_led_vars VARIABLE=pulse_stage VALUE={next_stage}
        
        UPDATE_DELAYED_GCODE ID=led_pulse_timer DURATION=0.25
    {% endif %}

[gcode_macro status_ready]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=ready
    _RING_READY

[gcode_macro status_off]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=off
    _RING_OFF

[gcode_macro status_busy]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=busy
    _RING_BUSY

[gcode_macro status_heating]
gcode:
    {% set pulse = params.PULSE|default(0)|int %}
    {% if pulse %}
        _start_pulse COLOR=heating
    {% else %}
        _stop_pulse
        _set_hotend_led_by_name COLOR=heating
    {% endif %}
    _RING_HEATING

[gcode_macro status_printing]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=printing
    _RING_PRINTING

[gcode_macro status_homing]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=homing
    _RING_HOMING

[gcode_macro status_leveling]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=leveling
    _RING_LEVELING

[gcode_macro status_meshing]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=meshing
    _RING_MESHING

[gcode_macro status_cleaning]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=cleaning
    _RING_CLEANING

[gcode_macro status_error]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=error
    _RING_ERROR

[gcode_macro status_paused]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=paused
    _RING_PAUSED

[gcode_macro status_completed]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=completed
    _RING_COMPLETED

[gcode_macro status_white]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=white
    _RING_PRINTING

[gcode_macro status_standby]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=standby
    _RING_STANDBY

[gcode_macro status_idle]
gcode:
    _stop_pulse
    _set_hotend_led_by_name COLOR=idle
    _RING_IDLE